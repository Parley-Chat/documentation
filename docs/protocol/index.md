---
title: Protocol
nav_order: 2
---

# Protocol

Information about the Parley protocol.

## Accounts

Accounts have two authentication factors: a public/private key pair (supported: [RSA-OAEP](#rsa-oaep)) and a passkey.\
The server MUST only store the public key and an encrypted version of the passkey, never receiving the private key.\
The public/private key pair MUST be generated by the client, and the passkey by the server.\
The server MUST verify the client using the passkey and by requiring the client to decrypt a challenge value encrypted with the public key.

**Flow diagram:**
```
Client                     Server
|                          |
| Key pair creation        |
| /signup ---------------> |
|                          | Challenge value encrypted
| <------------- Challenge |
| Decryption               |
| /challenge ------------> |
|                          | Verify and passkey creation
| <--- Passkey and session |
|                          |
```

## Messages

Users' key pairs are used for asymmetric encryption to exchange an ephemeral shared key (supported: [AES-GCM](#aes-gcm)) which is then used for symmetric encryption of messages.\
Shared keys SHOULD expire after one hour and MUST expire after one day to provide forward secrecy. This limits the impact of key compromise to a limited time window.\
If the shared key has expired, the next user to send a message MUST generate a new shared key. The key is then encrypted using each member's public key and each encrypted version is sent to the server.\
Messages are additionally signed with the user's private key using [RSA-PSS](#rsa-pss) (signature format: `${message_content}:${channel_id}:${unix_s}`).

Sending a message requires both parts of the user's key pair, public key so the correct encrypted shared key is used for encryption and private key for signing.\
This prevents man-in-the-middle (MitM) attacks since replacing the public key of a member with an attacker's public key would either invalidate the signature or decryption.

**Flow diagram:**\
Read:
```
Client                     Server
|                          |
| /messages -------------> |
| <-------------- Messages |
| /key ------------------> |
| <--- Specific shared key |
| Decrypt shared           |
| Decrypt message          |
| Verify message           |
|                          |
```
Send:
```
Client                     Server
|                          |
| /key ------------------> |
| <------- Last shared key |
|                          |
If expired:
|                          |
| Generate an AES key      |
| Encrypt key per member   |
| /keys -----------------> |
|                          | Save encrypted keys
|                          |
Finally:
|                          |
| Encrypt message          |
| Sign message             |
| /message --------------> |
|                          |
```

## Keys

### RSA-OAEP

- Label: `parley`
- Modulus length: `2048` bits
- Public exponent: `65537`
- Hash: `SHA-256`

### RSA-PSS

- Salt length: `222` bytes
- Hash: `SHA-256`

### AES-GCM

- Key length: `128` bits